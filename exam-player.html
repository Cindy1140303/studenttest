<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒé¡Œä½œç­”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex items-center justify-center p-4">
        <!-- è¼‰å…¥ä¸­ç‹€æ…‹ -->
        <div v-if="loading" class="text-center">
            <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
            <p class="text-white text-xl mt-4">è¼‰å…¥ä¸­...</p>
        </div>

        <!-- éŒ¯èª¤ç‹€æ…‹ -->
        <div v-else-if="error" class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full">
            <div class="text-center">
                <div class="text-6xl mb-4">âš ï¸</div>
                <h2 class="text-2xl font-bold text-red-600 mb-4">è¼‰å…¥å¤±æ•—</h2>
                <p class="text-gray-700 mb-6">{{ error }}</p>
                <button @click="reload" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                    é‡æ–°è¼‰å…¥
                </button>
            </div>
        </div>

        <!-- å‹•æ…‹ VUE çµ„ä»¶å®¹å™¨ -->
        <div v-else-if="ready" id="dynamic-component" class="w-full max-w-6xl">
            <!-- VUE çµ„ä»¶å°‡å‹•æ…‹æ¸²æŸ“åœ¨é€™è£¡ -->
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        const API_BASE_URL = 'https://studenttest.vercel.app/api';

        createApp({
            setup() {
                const loading = ref(true);
                const error = ref(null);
                const ready = ref(false);
                const question = ref(null);
                const modeCode = ref('');

                // å¾ URL ç²å–é¡Œç›® ID
                const urlParams = new URLSearchParams(window.location.search);
                const questionId = urlParams.get('id');

                // è¼‰å…¥é¡Œç›®å’Œæ¨¡å¼
                const loadExam = async () => {
                    try {
                        loading.value = true;
                        error.value = null;

                        if (!questionId) {
                            throw new Error('æœªæŒ‡å®šé¡Œç›® ID');
                        }

                        console.log('ğŸ“ è¼‰å…¥é¡Œç›® ID:', questionId);

                        // 1. ç²å–é¡Œç›®æ•¸æ“š
                        const questionResponse = await fetch(`${API_BASE_URL}/questions/${questionId}`);
                        if (!questionResponse.ok) {
                            throw new Error(`ç„¡æ³•è¼‰å…¥é¡Œç›®: HTTP ${questionResponse.status}`);
                        }

                        const questionResult = await questionResponse.json();
                        if (!questionResult.success) {
                            throw new Error(questionResult.error || 'é¡Œç›®è¼‰å…¥å¤±æ•—');
                        }

                        question.value = questionResult.data;
                        console.log('âœ… é¡Œç›®è¼‰å…¥æˆåŠŸ:', question.value);

                        // 2. æ ¹æ“šé¡Œç›®é¡å‹ç²å–æ¨¡å¼ç¨‹å¼ç¢¼
                        const questionType = question.value.type;
                        console.log('ğŸ¨ è¼‰å…¥æ¨¡å¼:', questionType);

                        const modesResponse = await fetch(`${API_BASE_URL}/modes`);
                        if (!modesResponse.ok) {
                            throw new Error(`ç„¡æ³•è¼‰å…¥æ¨¡å¼: HTTP ${modesResponse.status}`);
                        }

                        const modesResult = await modesResponse.json();
                        if (!modesResult.success) {
                            throw new Error('æ¨¡å¼è¼‰å…¥å¤±æ•—');
                        }

                        const mode = modesResult.data.find(m => m.name === questionType);
                        if (!mode) {
                            throw new Error(`æ‰¾ä¸åˆ°ã€Œ${questionType}ã€æ¨¡å¼`);
                        }

                        if (!mode.code || mode.code.trim() === '') {
                            throw new Error(`ã€Œ${questionType}ã€æ¨¡å¼å°šæœªå®šç¾©ç¨‹å¼ç¢¼`);
                        }

                        modeCode.value = mode.code;
                        console.log('âœ… æ¨¡å¼ç¨‹å¼ç¢¼è¼‰å…¥æˆåŠŸ');

                        // 3. å‹•æ…‹æ¸²æŸ“ VUE çµ„ä»¶
                        await renderDynamicComponent();

                    } catch (err) {
                        console.error('âŒ è¼‰å…¥éŒ¯èª¤:', err);
                        error.value = err.message;
                    } finally {
                        loading.value = false;
                    }
                };

                // å‹•æ…‹æ¸²æŸ“ VUE çµ„ä»¶
                const renderDynamicComponent = async () => {
                    try {
                        // å‰µå»ºå‹•æ…‹çµ„ä»¶
                        const dynamicApp = Vue.createApp({
                            template: modeCode.value,
                            data() {
                                return {
                                    question: question.value,
                                    userAnswer: null,
                                    showResult: false,
                                    isCorrect: false
                                };
                            },
                            methods: {
                                // æä¾›çµ¦æ¨¡å¼ç¨‹å¼ç¢¼ä½¿ç”¨çš„æ–¹æ³•
                                submitAnswer() {
                                    this.checkAnswer();
                                },
                                checkAnswer() {
                                    // æª¢æŸ¥ç­”æ¡ˆé‚è¼¯ï¼ˆæ ¹æ“šä¸åŒé¡Œå‹ï¼‰
                                    if (this.question.type === 'å–®é¸é¡Œ') {
                                        this.isCorrect = this.userAnswer === this.question.answer;
                                    } else if (this.question.type === 'å¤šé¸é¡Œ') {
                                        const userSet = new Set(this.userAnswer || []);
                                        const answerSet = new Set((this.question.answer || '').split(','));
                                        this.isCorrect = userSet.size === answerSet.size && 
                                            [...userSet].every(a => answerSet.has(a));
                                    } else if (this.question.type === 'æ˜¯éé¡Œ') {
                                        this.isCorrect = this.userAnswer === this.question.answer;
                                    } else if (this.question.type === 'å¡«ç©ºé¡Œ') {
                                        this.isCorrect = (this.userAnswer || '').trim().toLowerCase() === 
                                            (this.question.answer || '').trim().toLowerCase();
                                    }
                                    this.showResult = true;
                                },
                                resetAnswer() {
                                    this.userAnswer = null;
                                    this.showResult = false;
                                }
                            },
                            mounted() {
                                console.log('âœ… å‹•æ…‹çµ„ä»¶å·²æ›è¼‰');
                            }
                        });

                        // æ›è¼‰åˆ°å®¹å™¨
                        const container = document.getElementById('dynamic-component');
                        dynamicApp.mount(container);
                        
                        ready.value = true;
                        console.log('âœ… çµ„ä»¶æ¸²æŸ“å®Œæˆ');

                    } catch (err) {
                        console.error('âŒ çµ„ä»¶æ¸²æŸ“éŒ¯èª¤:', err);
                        throw new Error(`çµ„ä»¶æ¸²æŸ“å¤±æ•—: ${err.message}`);
                    }
                };

                const reload = () => {
                    window.location.reload();
                };

                onMounted(() => {
                    loadExam();
                });

                return {
                    loading,
                    error,
                    ready,
                    reload
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

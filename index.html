
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考題管理平台</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load Lucide icons for responsive design -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Load SheetJS for Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* Custom Styles to match the mockup's aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0; /* Light background matching mockup */
        }
        .nav-bar-bg {
            background-color: #e6e6e6; /* Slightly darker gray for the background section */
        }
        .tab-button {
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            margin-right: 0.5rem;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            color: white; /* 預設文字顏色：白色 (未點擊狀態) */
        }
        .tab-button::before {
            content: '•';
            position: absolute;
            left: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.25rem;
            line-height: 1;
            color: white; /* 預設小點顏色：白色 (未點擊狀態) */
        }
        /* Custom colors for tabs - ONLY set background color now, text color is controlled by .tab-button/.tab-active */
        .tab-green { background-color: #178a48; } /* 考題分派 */
        .tab-blue { background-color: #5284cb; } /* 考題管理 */
        .tab-orange { background-color: #ffb230; } /* 模式管理 */
        .tab-red { background-color: #ff694d; } /* 答題記錄 */
        
        /* The active tab has a different look and sets the active color */
        .tab-active {
            z-index: 10;
            margin-top: -1rem; /* Lift up the active tab */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            color: #333; /* 點擊後文字顏色：黑色/深灰色 */
        }
        /* Active bullet point color */
        .tab-active::before {
            color: #333; /* 點擊後小點顏色：黑色/深灰色 */
        }

        .input-style {
            background-color: #fff8e8; /* Light yellowish input background */
            border: 1px solid #ffcc99;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
        }
        .action-button {
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s;
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col">
    <!-- Header/Navigation Bar -->
    <header class="w-full flex flex-col justify-end z-10 pb-0" style="min-height: 120px;">
        <div class="text-center mt-16 mb-16">
            <h1 class="text-4xl font-bold text-gray-800 tracking-wide">考題管理平台</h1>
        </div>
        <div class="flex justify-end max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex">
                <button class="tab-button tab-green tab-active" data-tab="assignment" style="--button-color: #178a48;">考題分派</button>
                <button class="tab-button tab-blue" data-tab="management" style="--button-color: #5284cb;">考題管理</button>
                <button class="tab-button tab-orange" data-tab="mode" style="--button-color: #ffb230;">模式管理</button>
                <button class="tab-button tab-red" data-tab="record" style="--button-color: #ff694d;">答題記錄</button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow nav-bar-bg pt-12 pb-8 px-4 sm:px-6 lg:px-8">
        <div id="content-container" class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl min-h-[70vh]">
            
            <!-- 考題分派 Tab Content (Default Active) -->
            <div id="tab-assignment" class="active-content">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 hidden">考題分派</h2>

                <!-- Filter and Action Area (Matching image_8e3546.png) -->
                <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-8 mb-8 p-4 bg-gray-50 rounded-lg">
                    
                    <!-- Dropdown: 課別 (Course) -->
                    <div class="flex items-center space-x-3">
                        <label for="assign-course-select" class="text-gray-600 whitespace-nowrap">課別</label>
                        <div class="relative">
                            <select id="assign-course-select" class="input-style w-48 appearance-none focus:outline-none focus:ring-2 focus:ring-green-500 pr-10">
                                <option value="">請選擇課程</option>
                            </select>
                            <i data-lucide="chevron-down" class="text-gray-500 absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none w-5 h-5"></i>
                        </div>
                    </div>

                    <!-- Dropdown: 考題模式 (Exam Mode) -->
                    <div class="flex items-center space-x-3">
                        <label for="assign-mode-select" class="text-gray-600 whitespace-nowrap">考題模式</label>
                        <div class="relative">
                            <select id="assign-mode-select" class="input-style w-48 appearance-none focus:outline-none focus:ring-2 focus:ring-green-500 pr-10">
                                <option value="">請選擇模式</option>
                            </select>
                            <i data-lucide="chevron-down" class="text-gray-500 absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none w-5 h-5"></i>
                        </div>
                    </div>

                    <!-- Action Button: 確定/預覽 (Confirm/Preview) -->
                    <button id="confirm-assignment-button" class="action-button bg-gradient-to-r from-orange-400 to-pink-500 hover:from-orange-500 hover:to-pink-600 text-white md:ml-auto whitespace-nowrap">
                        確定/預覽
                    </button>
                </div>
                
                <!-- 考題預覽區域 -->
                <div id="assignment-preview" class="hidden">
                    <div class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-xl mb-6 border-2 border-green-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-2xl font-bold text-gray-800">
                                <i data-lucide="clipboard-list" class="inline w-6 h-6 mr-2"></i>
                                考題分派預覽
                            </h3>
                            <div class="text-sm text-gray-600">
                                <span class="font-semibold">課程:</span> <span id="preview-course" class="text-green-600"></span>
                                <span class="mx-3">|</span>
                                <span class="font-semibold">模式:</span> <span id="preview-mode" class="text-blue-600"></span>
                                <span class="mx-3">|</span>
                                <span class="font-semibold">題數:</span> <span id="preview-count" class="text-purple-600">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- 考題列表 -->
                    <div id="assignment-questions-list" class="space-y-4">
                        <!-- 這裡會動態載入考題 -->
                    </div>
                </div>

                <!-- 初始提示 -->
                <div id="assignment-placeholder" class="text-gray-500 p-8 border-4 border-dashed border-gray-200 rounded-xl text-center text-lg font-medium bg-white h-64 flex items-center justify-center">
                    選擇課程和考題模式後,點擊「確定/預覽」將顯示符合條件的考題清單
                </div>
            </div>

            
            <!-- Question Management Tab Content -->
            <div id="tab-management" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 hidden">考題管理</h2>

                <!-- Filter and Action Area -->
                <div class="flex flex-col md:flex-row md:items-center space-y-4 md:space-y-0 md:space-x-6 mb-8 p-4 bg-gray-50 rounded-lg">
                    
                    <!-- Dropdown: 課別 (Course) -->
                    <div class="flex items-center space-x-3">
                        <label for="course-select" class="text-gray-600 whitespace-nowrap">課別</label>
                        <div class="relative">
                            <select id="course-select" class="input-style w-40 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10">
                                <option value="">全部課程</option>
                            </select>
                            <i data-lucide="chevron-down" class="text-gray-500 absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none w-5 h-5"></i>
                        </div>
                    </div>

                    <!-- Dropdown: 知識點 (Knowledge Point) -->
                    <div class="flex items-center space-x-3">
                        <label for="knowledge-select" class="text-gray-600 whitespace-nowrap">知識點</label>
                        <div class="relative">
                            <select id="knowledge-select" class="input-style w-40 appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10">
                                <option value="">全部知識點</option>
                            </select>
                            <i data-lucide="chevron-down" class="text-gray-500 absolute right-2 top-1/2 transform -translate-y-1/2 pointer-events-none w-5 h-5"></i>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-col sm:flex-row md:ml-auto space-y-3 sm:space-y-0 sm:space-x-3">
                        <button id="query-button" class="action-button bg-gray-200 hover:bg-gray-300 text-gray-700">查詢</button>
                        <button id="import-button" class="action-button bg-pink-500 hover:bg-pink-600 text-white">匯入考題與答案</button>
                    </div>
                </div>

                <!-- Manual Add Button (Floating/Separated) -->
                <div class="flex justify-end mb-6">
                    <button id="manual-add-button" class="action-button bg-gradient-to-r from-orange-400 to-pink-500 hover:from-orange-500 hover:to-pink-600 text-white">
                        <i data-lucide="plus" class="inline w-5 h-5 mr-2"></i>
                        手動新增
                    </button>
                </div>
                
                <!-- Data Table -->
                <div class="overflow-x-auto rounded-lg shadow-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-600 text-white">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">匯入日期</th>
                                <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">課別</th>
                                <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">章節</th>
                                <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">知識點</th>
                                <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">題型</th>
                                <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">選項</th>
                                <th class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wider">答案</th>
                                <th class="px-3 py-3 text-center text-xs font-medium uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="question-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Mock data will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 模式管理 Tab Content (Matching image_8e3562.png) -->
            <div id="tab-mode" class="hidden">
                <h3 class="text-xl font-semibold mb-8 text-gray-800 text-center">互動考題模式定義 (VUE Code)</h3>

                <div id="modes-container" class="space-y-12 opacity-0 transition-opacity duration-300">
                    
                    <!-- Mode 1: 連連看 (Connect-the-Dots) -->
                    <div class="mode-block grid grid-cols-1 lg:grid-cols-2 gap-8 items-start p-4 border border-gray-200 rounded-xl bg-gray-50" data-mode-index="1">
                        <div class="flex items-start space-x-4">
                            <div class="flex flex-col items-center w-8">
                                <span class="text-2xl font-mono text-gray-500">1.</span>
                                <input type="checkbox" class="mode-checkbox mt-2 w-5 h-5 cursor-pointer" data-mode-index="1">
                            </div>
                            <div class="flex-grow">
                                <label class="text-sm font-medium text-gray-600 mb-2 block">HTML/JS/CSS code(VUE)</label>
                                <textarea id="mode-code-1" class="input-style w-full h-40 focus:outline-none focus:ring-2 focus:ring-orange-500 p-3 text-sm font-mono resize-none" placeholder="在此輸入 VUE 單檔案組件代碼（連連看模式）..."></textarea>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600 mb-2 block">對應模式名稱</label>
                            <input id="mode-name-1" type="text" value="連連看" class="input-style w-full text-lg font-bold text-center py-4 bg-yellow-200 border-yellow-500 text-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>

                    <!-- Mode 2: 拖拉方塊 (Drag Blocks) -->
                    <div class="mode-block grid grid-cols-1 lg:grid-cols-2 gap-8 items-start p-4 border border-gray-200 rounded-xl bg-gray-50" data-mode-index="2">
                        <div class="flex items-start space-x-4">
                            <div class="flex flex-col items-center w-8">
                                <span class="text-2xl font-mono text-gray-500">2.</span>
                                <input type="checkbox" class="mode-checkbox mt-2 w-5 h-5 cursor-pointer" data-mode-index="2">
                            </div>
                            <div class="flex-grow">
                                <label class="text-sm font-medium text-gray-600 mb-2 block">HTML/JS/CSS code(VUE)</label>
                                <textarea id="mode-code-2" class="input-style w-full h-40 focus:outline-none focus:ring-2 focus:ring-orange-500 p-3 text-sm font-mono resize-none" placeholder="在此輸入 VUE 單檔案組件代碼（拖拉方塊模式）..."></textarea>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600 mb-2 block">對應模式名稱</label>
                            <input id="mode-name-2" type="text" value="拖拉方塊" class="input-style w-full text-lg font-bold text-center py-4 bg-yellow-200 border-yellow-500 text-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>
                    
                    <!-- Mode 3: 單選題 (Single Choice) -->
                    <div class="mode-block grid grid-cols-1 lg:grid-cols-2 gap-8 items-start p-4 border border-gray-200 rounded-xl bg-gray-50" data-mode-index="3">
                        <div class="flex items-start space-x-4">
                            <div class="flex flex-col items-center w-8">
                                <span class="text-2xl font-mono text-gray-500">3.</span>
                                <input type="checkbox" class="mode-checkbox mt-2 w-5 h-5 cursor-pointer" data-mode-index="3">
                            </div>
                            <div class="flex-grow">
                                <label class="text-sm font-medium text-gray-600 mb-2 block">HTML/JS/CSS code(VUE)</label>
                                <textarea id="mode-code-3" class="input-style w-full h-40 focus:outline-none focus:ring-2 focus:ring-orange-500 p-3 text-sm font-mono resize-none" placeholder="在此輸入 VUE 單檔案組件代碼（單選題模式）..."></textarea>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600 mb-2 block">對應模式名稱</label>
                            <input id="mode-name-3" type="text" value="單選題" class="input-style w-full text-lg font-bold text-center py-4 bg-yellow-200 border-yellow-500 text-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>

                    <!-- Mode 4: 多選題 (Multiple Choice) -->
                    <div class="mode-block grid grid-cols-1 lg:grid-cols-2 gap-8 items-start p-4 border border-gray-200 rounded-xl bg-gray-50" data-mode-index="4">
                        <div class="flex items-start space-x-4">
                            <div class="flex flex-col items-center w-8">
                                <span class="text-2xl font-mono text-gray-500">4.</span>
                                <input type="checkbox" class="mode-checkbox mt-2 w-5 h-5 cursor-pointer" data-mode-index="4">
                            </div>
                            <div class="flex-grow">
                                <label class="text-sm font-medium text-gray-600 mb-2 block">HTML/JS/CSS code(VUE)</label>
                                <textarea id="mode-code-4" class="input-style w-full h-40 focus:outline-none focus:ring-2 focus:ring-orange-500 p-3 text-sm font-mono resize-none" placeholder="在此輸入 VUE 單檔案組件代碼（多選題模式）..."></textarea>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600 mb-2 block">對應模式名稱</label>
                            <input id="mode-name-4" type="text" value="多選題" class="input-style w-full text-lg font-bold text-center py-4 bg-yellow-200 border-yellow-500 text-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>

                    <!-- Mode 5: 是非題 (True/False) -->
                    <div class="mode-block grid grid-cols-1 lg:grid-cols-2 gap-8 items-start p-4 border border-gray-200 rounded-xl bg-gray-50" data-mode-index="5">
                        <div class="flex items-start space-x-4">
                            <div class="flex flex-col items-center w-8">
                                <span class="text-2xl font-mono text-gray-500">5.</span>
                                <input type="checkbox" class="mode-checkbox mt-2 w-5 h-5 cursor-pointer" data-mode-index="5">
                            </div>
                            <div class="flex-grow">
                                <label class="text-sm font-medium text-gray-600 mb-2 block">HTML/JS/CSS code(VUE)</label>
                                <textarea id="mode-code-5" class="input-style w-full h-40 focus:outline-none focus:ring-2 focus:ring-orange-500 p-3 text-sm font-mono resize-none" placeholder="在此輸入 VUE 單檔案組件代碼（是非題模式）..."></textarea>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600 mb-2 block">對應模式名稱</label>
                            <input id="mode-name-5" type="text" value="是非題" class="input-style w-full text-lg font-bold text-center py-4 bg-yellow-200 border-yellow-500 text-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>

                    <!-- Mode 6: 填空題 (Fill in the Blank) -->
                    <div class="mode-block grid grid-cols-1 lg:grid-cols-2 gap-8 items-start p-4 border border-gray-200 rounded-xl bg-gray-50" data-mode-index="6">
                        <div class="flex items-start space-x-4">
                            <div class="flex flex-col items-center w-8">
                                <span class="text-2xl font-mono text-gray-500">6.</span>
                                <input type="checkbox" class="mode-checkbox mt-2 w-5 h-5 cursor-pointer" data-mode-index="6">
                            </div>
                            <div class="flex-grow">
                                <label class="text-sm font-medium text-gray-600 mb-2 block">HTML/JS/CSS code(VUE)</label>
                                <textarea id="mode-code-6" class="input-style w-full h-40 focus:outline-none focus:ring-2 focus:ring-orange-500 p-3 text-sm font-mono resize-none" placeholder="在此輸入 VUE 單檔案組件代碼（填空題模式）..."></textarea>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600 mb-2 block">對應模式名稱</label>
                            <input id="mode-name-6" type="text" value="填空題" class="input-style w-full text-lg font-bold text-center py-4 bg-yellow-200 border-yellow-500 text-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-500">
                        </div>
                    </div>

                    <!-- 操作按鈕區 -->
                    <div class="mt-8 space-y-4">
                        <!-- 選擇操作 -->
                        <div class="flex justify-center gap-3">
                            <button id="select-all-modes-button" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-sm">
                                <i data-lucide="check-square" class="inline w-4 h-4 mr-1"></i>
                                全選
                            </button>
                            <button id="deselect-all-modes-button" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-sm">
                                <i data-lucide="square" class="inline w-4 h-4 mr-1"></i>
                                取消全選
                            </button>
                            <button id="delete-selected-modes-button" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm">
                                <i data-lucide="trash-2" class="inline w-4 h-4 mr-1"></i>
                                刪除已選
                            </button>
                        </div>
                        
                        <!-- 主要操作 -->
                        <div class="flex justify-center gap-4">
                            <button id="add-mode-button" class="action-button bg-gradient-to-r from-green-400 to-teal-500 hover:from-green-500 hover:to-teal-600 text-white px-8 py-4 text-lg">
                                <i data-lucide="plus-circle" class="inline w-5 h-5 mr-2"></i>
                                新增模式
                            </button>
                            <button id="save-modes-button" class="action-button bg-gradient-to-r from-orange-400 to-pink-500 hover:from-orange-500 hover:to-pink-600 text-white px-12 py-4 text-lg">
                                <i data-lucide="save" class="inline w-5 h-5 mr-2"></i>
                                儲存所有模式
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 答題記錄 Tab Content -->
            <div id="tab-record" class="hidden p-8">
                <div class="max-w-7xl mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">答題記錄統計</h2>
                        <button onclick="refreshRecords()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            重新整理
                        </button>
                    </div>

                    <!-- 統計摘要卡片 -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-100 text-sm">總答題次數</p>
                                    <p id="total-attempts" class="text-3xl font-bold mt-2">0</p>
                                </div>
                                <i data-lucide="file-text" class="w-12 h-12 opacity-50"></i>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-100 text-sm">答對次數</p>
                                    <p id="correct-attempts" class="text-3xl font-bold mt-2">0</p>
                                </div>
                                <i data-lucide="check-circle" class="w-12 h-12 opacity-50"></i>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-100 text-sm">整體答對率</p>
                                    <p id="overall-rate" class="text-3xl font-bold mt-2">0%</p>
                                </div>
                                <i data-lucide="trending-up" class="w-12 h-12 opacity-50"></i>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-xl shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-orange-100 text-sm">平均答題時間</p>
                                    <p id="avg-time" class="text-3xl font-bold mt-2">0秒</p>
                                </div>
                                <i data-lucide="clock" class="w-12 h-12 opacity-50"></i>
                            </div>
                        </div>
                    </div>

                    <!-- 篩選器 -->
                    <div class="bg-white p-4 rounded-lg shadow mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">題型篩選</label>
                                <select id="filter-type" onchange="filterRecords()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">全部題型</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">答題結果</label>
                                <select id="filter-result" onchange="filterRecords()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">全部結果</option>
                                    <option value="correct">答對</option>
                                    <option value="incorrect">答錯</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">課程篩選</label>
                                <select id="filter-course" onchange="filterRecords()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">全部課程</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 記錄列表 -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">答題時間</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">課程</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">題型</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">學生答案</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">正確答案</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">結果</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">花費時間</th>
                                    </tr>
                                </thead>
                                <tbody id="records-table-body" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                                            <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin"></i>
                                            <p>載入中...</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Message Box for alerts/confirmation (placed outside the main content block) -->
        <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full text-center">
                <p id="message-text" class="text-lg font-medium mb-4 text-gray-700"></p>
                <button id="message-confirm" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold w-full">確定</button>
            </div>
        </div>

        <!-- 手動新增考題表單 -->
        <div id="add-question-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-lg shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-bold mb-6 text-gray-800">手動新增考題</h3>
                <form id="add-question-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">課別 *</label>
                            <input type="text" id="new-course" required class="input-style w-full" placeholder="例如：數學">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">章節 *</label>
                            <input type="text" id="new-chapter" required class="input-style w-full" placeholder="例如：第1章">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">知識點 *</label>
                        <input type="text" id="new-knowledge" required class="input-style w-full" placeholder="例如：代數">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">題型 *</label>
                        <select id="new-type" required class="input-style w-full">
                            <option value="">請選擇題型</option>
                            <option value="單選題">單選題</option>
                            <option value="多選題">多選題</option>
                            <option value="是非題">是非題</option>
                            <option value="填空題">填空題</option>
                            <option value="連連看">連連看</option>
                            <option value="拖拉方塊">拖拉方塊</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">題目內容 *</label>
                        <textarea id="new-content" required class="input-style w-full h-24" placeholder="請輸入題目內容"></textarea>
                    </div>
                    
                    <!-- 一般題型的選項和答案 -->
                    <div id="new-standard-fields">
                        <div id="new-options-container">
                            <label class="block text-sm font-medium text-gray-700 mb-2">選項 *</label>
                            <textarea id="new-options" required class="input-style w-full h-32 font-mono text-sm" placeholder="等待選擇題型..."></textarea>
                            <div id="new-options-help" class="text-xs text-gray-500 mt-2 bg-blue-50 p-3 rounded">
                                <p class="font-semibold mb-1">📌 格式說明:</p>
                                <p id="new-format-hint">請先選擇題型</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">答案 *</label>
                            <input type="text" id="new-answer" required class="input-style w-full" placeholder="例如：B 或多個答案：A,C,D">
                            <p id="new-answer-help" class="text-xs text-gray-500 mt-1">💡 多個答案請用逗號分隔（例如：A,C,D）</p>
                        </div>
                    </div>
                    
                    <!-- 拖拉方塊專用編輯器 -->
                    <div id="new-drag-block-editor" class="hidden">
                        <div class="bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-300 rounded-xl p-6 shadow-lg">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <label class="text-xl font-bold text-amber-900">📝 程式片段拖拉設定</label>
                                    <p class="text-sm text-amber-700 mt-1">設定左側可拖拉片段與右側目標位置</p>
                                </div>
                                <button type="button" id="new-add-drag-row" class="bg-amber-600 hover:bg-amber-700 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-lg transform hover:scale-105 transition">
                                    ➕ 新增一組
                                </button>
                            </div>
                            
                            <!-- 配對列表 -->
                            <div id="new-drag-pairs-list" class="space-y-4 mb-4 w-full">
                                <!-- 動態生成的配對將顯示在這裡 -->
                            </div>
                            
                            <div class="mt-4 p-4 bg-amber-100 rounded-lg border border-amber-300">
                                <p class="text-sm text-amber-900">
                                    <strong>💡 提示：</strong><br>
                                    • <strong>左側片段</strong>：學生可以拖拉的程式碼（會被隨機打亂）<br>
                                    • <strong>右側槽位</strong>：可留空（拖放區）或填入預設程式碼<br>
                                    • 順序對應：第1組左側對應第1個右側槽位，以此類推<br>
                                    • 右側留空時顯示為虛線框，學生需要拖入正確片段
                                </p>
                            </div>
                            
                            <!-- 答案欄位 -->
                            <div class="mt-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">答案（正確擺放順序）*</label>
                                <input type="text" id="new-drag-answer" required class="input-style w-full" placeholder="例如：1,2,3,4 或填入 auto 讓系統自動驗證">
                                <p class="text-xs text-gray-500 mt-1">💡 填入正確擺放順序（例如：1,2,3,4）或填入 auto 讓系統自動驗證</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">
                            確定新增
                        </button>
                        <button type="button" id="cancel-add-button" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg font-semibold">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 編輯考題表單 -->
        <div id="edit-question-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
            <div class="bg-white p-8 rounded-lg shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                <h3 class="text-2xl font-bold mb-6 text-gray-800">編輯考題</h3>
                <form id="edit-question-form" class="space-y-4">
                    <input type="hidden" id="edit-question-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">課別 *</label>
                            <input type="text" id="edit-course" required class="input-style w-full" placeholder="例如：數學">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">章節 *</label>
                            <input type="text" id="edit-chapter" required class="input-style w-full" placeholder="例如：第1章">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">知識點 *</label>
                        <input type="text" id="edit-knowledge" required class="input-style w-full" placeholder="例如：代數">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">題型 *</label>
                        <select id="edit-type" required class="input-style w-full">
                            <option value="">請選擇題型</option>
                            <option value="單選題">單選題</option>
                            <option value="多選題">多選題</option>
                            <option value="是非題">是非題</option>
                            <option value="填空題">填空題</option>
                            <option value="連連看">連連看</option>
                            <option value="拖拉方塊">拖拉方塊</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">題目內容 *</label>
                        <textarea id="edit-content" required class="input-style w-full h-24" placeholder="請輸入題目內容"></textarea>
                    </div>
                    
                    <!-- 一般題型的選項和答案 -->
                    <div id="edit-standard-fields">
                        <div id="edit-options-container">
                            <label class="block text-sm font-medium text-gray-700 mb-2">選項 *</label>
                            <textarea id="edit-options" required class="input-style w-full h-32 font-mono text-sm" placeholder="等待選擇題型..."></textarea>
                            <div id="edit-options-help" class="text-xs text-gray-500 mt-2 bg-blue-50 p-3 rounded">
                                <p class="font-semibold mb-1">📌 格式說明:</p>
                                <p id="edit-format-hint">請先選擇題型</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">答案 *</label>
                            <input type="text" id="edit-answer" required class="input-style w-full" placeholder="例如：B 或多個答案：A,C,D">
                            <p id="edit-answer-help" class="text-xs text-gray-500 mt-1">💡 多個答案請用逗號分隔（例如：A,C,D）</p>
                        </div>
                    </div>
                    
                    <!-- 拖拉方塊專用編輯器 -->
                    <div id="edit-drag-block-editor" class="hidden">
                        <div class="bg-gradient-to-br from-amber-50 to-orange-50 border-2 border-amber-300 rounded-xl p-6 shadow-lg">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <label class="text-xl font-bold text-amber-900">📝 程式片段拖拉設定</label>
                                    <p class="text-sm text-amber-700 mt-1">設定左側可拖拉片段與右側目標位置</p>
                                </div>
                                <button type="button" id="edit-add-drag-row" class="bg-amber-600 hover:bg-amber-700 text-white px-6 py-3 rounded-lg font-bold text-lg shadow-lg transform hover:scale-105 transition">
                                    ➕ 新增一組
                                </button>
                            </div>
                            
                            <!-- 配對列表 -->
                            <div id="edit-drag-pairs-list" class="space-y-4 mb-4 w-full">
                                <!-- 動態生成的配對將顯示在這裡 -->
                            </div>
                            
                            <div class="mt-4 p-4 bg-amber-100 rounded-lg border border-amber-300">
                                <p class="text-sm text-amber-900">
                                    <strong>💡 提示：</strong><br>
                                    • 按照<strong>正確順序</strong>新增程式碼片段<br>
                                    • 學生答題時，左側片段會被<strong>隨機打亂</strong><br>
                                    • 學生需要將片段拖到右側對應的位置<br>
                                    • 系統會自動驗證順序是否正確
                                </p>
                            </div>
                            
                            <!-- 答案欄位 -->
                            <div class="mt-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">答案（正確擺放順序）*</label>
                                <input type="text" id="edit-drag-answer" required class="input-style w-full" placeholder="例如：1,2,3,4 或填入 auto 讓系統自動驗證">
                                <p class="text-xs text-gray-500 mt-1">💡 填入正確擺放順序（例如：1,2,3,4）或填入 auto 讓系統自動驗證</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">
                            確定更新
                        </button>
                        <button type="button" id="cancel-edit-button" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg font-semibold">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Excel 匯入表單 -->
        <div id="import-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-8 rounded-lg shadow-2xl max-w-lg w-full">
                <h3 class="text-2xl font-bold mb-6 text-gray-800">匯入 Excel 檔案</h3>
                <div class="space-y-4">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <input type="file" id="excel-file-input" accept=".xlsx,.xls,.csv" class="hidden">
                        <label for="excel-file-input" class="cursor-pointer">
                            <i data-lucide="upload" class="w-12 h-12 mx-auto mb-4 text-gray-400"></i>
                            <p class="text-lg font-medium text-gray-700 mb-2">點擊上傳 Excel 檔案</p>
                            <p class="text-sm text-gray-500">支援格式：.xlsx, .xls, .csv</p>
                        </label>
                        <p id="file-name" class="mt-4 text-sm text-gray-600"></p>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-blue-800 font-medium mb-2">📋 Excel 格式說明：</p>
                        <p class="text-xs text-blue-700">第一行為標題：課別、章節、知識點、題型、題目內容、選項、答案</p>
                    </div>
                    <div class="flex space-x-3 pt-4">
                        <button id="confirm-import-button" disabled class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                            確定匯入
                        </button>
                        <button id="cancel-import-button" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg font-semibold">
                            取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    // Initialize Lucide Icons
    lucide.createIcons();

    // API 基礎 URL（開發時使用本地，部署時改為實際 API 地址）
    const API_BASE_URL = 'https://studenttest.vercel.app/api';
    
    // 備用假資料（當後端無法連接時使用）
    const mockQuestions = [
        { id: '1', date: '2025/01/10', course: '數學', chapter: '第3章', knowledge: '微積分', type: '單選題', options: 'A. 2,B. 4,C. 8,D. 16', answer: 'B' },
        { id: '2', date: '2025/01/10', course: '歷史', chapter: '第5章', knowledge: '古代文明', type: '連連看', options: '4組', answer: '見圖' },
        { id: '3', date: '2025/01/11', course: '英文', chapter: '第1章', knowledge: '文法', type: '是非題', options: '是,否', answer: '是' },
        { id: '4', date: '2025/01/11', course: '數學', chapter: '第1章', knowledge: '代數', type: '單選題', options: 'A. 3,B. 4,C. 5,D. 6', answer: 'B' },
        { id: '5', date: '2025/01/12', course: '歷史', chapter: '第2章', knowledge: '近代史', type: '單選題', options: 'A. 1912,B. 1914,C. 1916,D. 1918', answer: 'B' }
    ];

    // 儲存從 API 取得的考題資料
    let questionsData = [];

    const tableBody = document.getElementById('question-table-body');
    const tabButtons = document.querySelectorAll('.tab-button');
    const contentContainer = document.getElementById('content-container');
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');
    const messageConfirm = document.getElementById('message-confirm');

    // Function to show custom message box
    function showMessage(text) {
        messageText.textContent = text;
        messageBox.classList.remove('hidden');
        messageBox.classList.add('flex');
    }

    // Event listener for message box confirmation
    messageConfirm.addEventListener('click', () => {
        messageBox.classList.add('hidden');
        messageBox.classList.remove('flex');
    });

    // 從 API 取得考題資料
    async function fetchQuestions(filters = {}) {
        try {
            // 建立查詢參數
            const queryParams = new URLSearchParams();
            if (filters.course) queryParams.append('course', filters.course);
            if (filters.knowledge) queryParams.append('knowledge', filters.knowledge);
            if (filters.chapter) queryParams.append('chapter', filters.chapter);
            
            const url = `${API_BASE_URL}/questions${queryParams.toString() ? '?' + queryParams.toString() : ''}`;
            const response = await fetch(url);
            const result = await response.json();
            
            if (result.success) {
                questionsData = result.data;
                populateManagementCourses(); // 填充課別下拉選單
                populateManagementKnowledge(); // 填充知識點下拉選單
                renderQuestions();
                console.log(`✅ 成功從後端 API 載入 ${result.data.length} 筆考題資料`);
            } else {
                throw new Error(result.message || '載入失敗');
            }
        } catch (error) {
            console.warn('⚠️ 無法連接後端 API，使用示範資料:', error.message);
            // 使用備用假資料
            questionsData = mockQuestions;
            renderQuestions();
        }
    }
    
    // 填充考題管理的課別下拉選單
    function populateManagementCourses() {
        const courseSelect = document.getElementById('course-select');
        const currentValue = courseSelect.value; // 保存當前選擇
        
        // 取得所有唯一的課別
        const courses = [...new Set(questionsData.map(q => q.course))].filter(Boolean).sort();
        
        courseSelect.innerHTML = '<option value="">全部課程</option>';
        courses.forEach(course => {
            const option = document.createElement('option');
            option.value = course;
            option.textContent = course;
            courseSelect.appendChild(option);
        });
        
        // 恢復之前的選擇
        if (currentValue && courses.includes(currentValue)) {
            courseSelect.value = currentValue;
        }
    }
    
    // 填充考題管理的知識點下拉選單
    function populateManagementKnowledge() {
        const knowledgeSelect = document.getElementById('knowledge-select');
        const courseSelect = document.getElementById('course-select');
        const currentValue = knowledgeSelect.value; // 保存當前選擇
        const selectedCourse = courseSelect.value;
        
        // 根據選擇的課別過濾知識點
        let filteredQuestions = questionsData;
        if (selectedCourse) {
            filteredQuestions = questionsData.filter(q => q.course === selectedCourse);
        }
        
        // 取得所有唯一的知識點
        const knowledgePoints = [...new Set(filteredQuestions.map(q => q.knowledge))].filter(Boolean).sort();
        
        knowledgeSelect.innerHTML = '<option value="">全部知識點</option>';
        knowledgePoints.forEach(knowledge => {
            const option = document.createElement('option');
            option.value = knowledge;
            option.textContent = knowledge;
            knowledgeSelect.appendChild(option);
        });
        
        // 恢復之前的選擇（如果仍然存在）
        if (currentValue && knowledgePoints.includes(currentValue)) {
            knowledgeSelect.value = currentValue;
        }
    }

    // Render Table Data for '考題管理' tab
    function renderQuestions() {
        tableBody.innerHTML = ''; // Clear existing rows
        
        if (questionsData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-3 py-8 text-center text-gray-500">
                        <p class="text-lg">暫無考題資料</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        questionsData.forEach((q, index) => {
            const row = document.createElement('tr');
            row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
            const questionId = q._id || q.id;
            
            row.innerHTML = `
                <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${q.date || '未設定'}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${q.course}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${q.chapter || '-'}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${q.knowledge || '-'}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${q.type}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${q.options || '-'}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${q.answer}</td>
                <td class="px-3 py-4 whitespace-nowrap text-center text-sm font-medium">
                    <div class="flex items-center justify-center space-x-2">
                        <!-- Edit Button -->
                        <button onclick="handleAction('edit', '${questionId}')" class="text-blue-500 hover:text-blue-700 p-2 rounded-full hover:bg-blue-100 transition">
                            <i data-lucide="pencil" class="w-5 h-5"></i>
                        </button>
                        <!-- Delete Button -->
                        <button onclick="handleAction('delete', '${questionId}')" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
        // Re-initialize icons for newly added table rows
        lucide.createIcons();
    }

    // Handle Edit/Delete Actions (for '考題管理')
    window.handleAction = async function(action, questionId) {
        const question = questionsData.find(q => q.id === questionId || q._id === questionId);
        if (!question) return;
        
        if (action === 'edit') {
            // 開啟編輯視窗並填入資料
            openEditModal(question);
        } else if (action === 'delete') {
            if (confirm(`確認要刪除：${question.course} - ${question.type} 考題嗎？`)) {
                try {
                    const response = await fetch(`${API_BASE_URL}/questions/${questionId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        showMessage('刪除成功！');
                        fetchQuestions(); // 重新載入資料
                    } else {
                        showMessage('刪除失敗：' + result.message);
                    }
                } catch (error) {
                    showMessage('刪除失敗：' + error.message);
                }
            }
        }
    }

    // 開啟編輯視窗
    function openEditModal(question) {
        const editModal = document.getElementById('edit-question-modal');
        
        // 填入現有資料
        document.getElementById('edit-question-id').value = question._id || question.id;
        document.getElementById('edit-course').value = question.course || '';
        document.getElementById('edit-chapter').value = question.chapter || '';
        document.getElementById('edit-knowledge').value = question.knowledge || '';
        document.getElementById('edit-type').value = question.type || '';
        document.getElementById('edit-content').value = question.content || '';
        document.getElementById('edit-options').value = question.options || '';
        document.getElementById('edit-answer').value = question.answer || '';
        
        // 如果是拖拉方塊，解析並顯示編輯器
        if (question.type === '拖拉方塊') {
            document.getElementById('edit-standard-fields').classList.add('hidden');
            document.getElementById('edit-drag-block-editor').classList.remove('hidden');
            
            // 填入拖拉方塊的答案
            document.getElementById('edit-drag-answer').value = question.answer || '';
            
            // 解析現有數據：左側|右側\n左側|右側
            if (question.options && question.options.trim()) {
                editDragPairs = question.options.split('\n')
                    .filter(line => line.trim())
                    .map(line => {
                        const parts = line.split('|');
                        return {
                            left: parts[0] || '',
                            right: parts[1] || ''
                        };
                    });
                renderEditDragPairs();
            } else {
                editDragPairs = [];
                renderEditDragPairs();
            }
        } else {
            document.getElementById('edit-standard-fields').classList.remove('hidden');
            document.getElementById('edit-drag-block-editor').classList.add('hidden');
        }
        
        editModal.classList.remove('hidden');
        editModal.classList.add('flex');
    }

    // 編輯表單提交
    const editQuestionForm = document.getElementById('edit-question-form');
    editQuestionForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const questionId = document.getElementById('edit-question-id').value;
        const questionType = document.getElementById('edit-type').value;
        let options, answer;
        
        // 如果是拖拉方塊，從編輯器獲取數據
        if (questionType === '拖拉方塊') {
            if (editDragPairs.length === 0) {
                showMessage('❌ 請至少新增一組配對');
                return;
            }
            
            // 檢查左側是否都有填寫
            const hasEmptyLeft = editDragPairs.some(pair => !pair.left.trim());
            if (hasEmptyLeft) {
                showMessage('❌ 左側程式片段不能為空');
                return;
            }
            
            // 格式：左側|右側\n左側|右側（右側可以為空）
            options = editDragPairs.map(pair => `${pair.left.trim()}|${pair.right.trim()}`).join('\n');
            // 從拖拉方塊專用答案欄位獲取答案
            answer = document.getElementById('edit-drag-answer').value;
        } else {
            options = document.getElementById('edit-options').value;
            answer = document.getElementById('edit-answer').value;
        }
        
        const questionData = {
            course: document.getElementById('edit-course').value,
            chapter: document.getElementById('edit-chapter').value,
            knowledge: document.getElementById('edit-knowledge').value,
            type: questionType,
            content: document.getElementById('edit-content').value,
            options: options,
            answer: answer
        };
        
        try {
            const response = await fetch(`${API_BASE_URL}/questions/${questionId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(questionData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showMessage('✅ 考題更新成功！');
                editModal.classList.add('hidden');
                editModal.classList.remove('flex');
                fetchQuestions(); // 重新載入資料
            } else {
                showMessage('❌ 更新失敗：' + result.message);
            }
        } catch (error) {
            showMessage('❌ 更新失敗：' + error.message);
        }
    });

    // 取消編輯按鈕
    const cancelEditBtn = document.getElementById('cancel-edit-button');
    const editModal = document.getElementById('edit-question-modal');
    cancelEditBtn.addEventListener('click', function() {
        editModal.classList.add('hidden');
        editModal.classList.remove('flex');
    });

    // Tab Switching Logic
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.getAttribute('data-tab');

            // 1. Update Tab Visuals
            tabButtons.forEach(btn => {
                btn.classList.remove('tab-active');
                btn.style.marginTop = '0';
            });
            button.classList.add('tab-active');
            button.style.marginTop = '-1rem';

            // 2. Switch Content
            document.querySelectorAll('#content-container > div').forEach(content => {
                if (content.id === `tab-${targetTab}`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
            
            // Re-render table when switching back to management (optional, but good practice for dynamic data)
            if (targetTab === 'management') {
                fetchQuestions(); // 從 API 載入資料
            }
            
            // 切換到答題記錄時重新載入數據並初始化 icons
            if (targetTab === 'record') {
                loadRecords();
                setTimeout(() => lucide.createIcons(), 100); // 延遲初始化確保 DOM 已更新
            }
        });
    });

    // ========== 新功能：查詢按鈕 ==========
    // 課別選單變更時，更新知識點選單
    document.getElementById('course-select').addEventListener('change', function() {
        populateManagementKnowledge();
    });
    
    document.getElementById('query-button').addEventListener('click', function() {
        const course = document.getElementById('course-select').value;
        const knowledge = document.getElementById('knowledge-select').value;
        
        const filters = {};
        if (course) filters.course = course;
        if (knowledge) filters.knowledge = knowledge;
        
        fetchQuestions(filters);
        showMessage('查詢中...');
    });

    // ========== 題型格式說明 ==========
    const questionTypeFormats = {
        '單選題': {
            optionsPlaceholder: 'A. 選項1\nB. 選項2\nC. 選項3\nD. 選項4',
            optionsHint: '單選題: 每行一個選項，格式為「選項編號. 內容」',
            answerHint: '填入正確選項的編號，例如: A 或 B'
        },
        '多選題': {
            optionsPlaceholder: 'A. 選項1\nB. 選項2\nC. 選項3\nD. 選項4',
            optionsHint: '多選題: 每行一個選項，格式為「選項編號. 內容」',
            answerHint: '填入所有正確選項，用逗號分隔，例如: A,C'
        },
        '是非題': {
            optionsPlaceholder: 'A. 是\nB. 否',
            optionsHint: '是非題: 固定為「是」和「否」兩個選項',
            answerHint: '填入 A 或 B'
        },
        '填空題': {
            optionsPlaceholder: '(可留空或填入提示)',
            optionsHint: '填空題: 可不填選項，或填入答案提示',
            answerHint: '填入標準答案'
        },
        '連連看': {
            optionsPlaceholder: '蘋果|Apple\n香蕉|Banana\n貓|Cat\n狗|Dog',
            optionsHint: '連連看: 每行一組配對，用「|」符號分隔左右兩側，例如: 中文|英文',
            answerHint: '填入 auto (系統自動驗證配對正確性)'
        },
        '拖拉方塊': {
            optionsPlaceholder: 'def factorial(n):\n    if n < 0: return None\n    result = 1\n    for i in range(1, n + 1):\n        result *= i\n    return result',
            optionsHint: '拖拉方塊: 每行一個程式碼片段，按正確順序填寫(學生答題時會被打亂)',
            answerHint: '填入正確擺放順序（例如：1,2,3,4 表示第1組在第1位，第2組在第2位...）或填入 auto 讓系統自動驗證'
        }
    };

    // 拖拉方塊編輯器狀態
    let newDragPairs = []; // 格式：[{left: '', right: ''}, ...]

    // 更新題型格式提示（新增表單）
    document.getElementById('new-type').addEventListener('change', function() {
        const selectedType = this.value;
        const standardFields = document.getElementById('new-standard-fields');
        const dragBlockEditor = document.getElementById('new-drag-block-editor');
        const optionsField = document.getElementById('new-options');
        const formatHint = document.getElementById('new-format-hint');
        const answerHelp = document.getElementById('new-answer-help');
        const answerField = document.getElementById('new-answer');
        
        // 切換顯示模式
        if (selectedType === '拖拉方塊') {
            // 完全隱藏標準欄位（選項和答案）
            standardFields.classList.add('hidden');
            dragBlockEditor.classList.remove('hidden');
            // 移除標準欄位的 required 屬性
            optionsField.removeAttribute('required');
            answerField.removeAttribute('required');
            
            // 如果是空的，初始化一些配對區塊
            if (newDragPairs.length === 0) {
                newDragPairs = [
                    { left: '', right: '' },
                    { left: '', right: '' },
                    { left: '', right: '' }
                ];
            }
            renderNewDragPairs();
        } else {
            // 顯示標準欄位，隱藏拖拉方塊編輯器
            standardFields.classList.remove('hidden');
            dragBlockEditor.classList.add('hidden');
            // 恢復 required 屬性
            optionsField.setAttribute('required', 'required');
            answerField.setAttribute('required', 'required');
            answerField.removeAttribute('readonly');
        }
        
        if (selectedType && questionTypeFormats[selectedType]) {
            const format = questionTypeFormats[selectedType];
            optionsField.placeholder = format.optionsPlaceholder;
            formatHint.textContent = format.optionsHint;
            answerHelp.textContent = format.answerHint;
            
            // 只有連連看自動填入 auto
            if (selectedType === '連連看') {
                answerField.value = 'auto';
            } else {
                // 其他題型（包括拖拉方塊）清空，讓管理者填寫
                answerField.value = '';
            }
        } else {
            optionsField.placeholder = '請先選擇題型';
            formatHint.textContent = '請先選擇題型';
            answerHelp.textContent = '';
        }
    });

    // 拖拉方塊編輯器：新增一組配對
    document.getElementById('new-add-drag-row').addEventListener('click', function() {
        newDragPairs.push({ left: '', right: '' });
        renderNewDragPairs();
    });

    // 渲染配對列表
    function renderNewDragPairs() {
        const container = document.getElementById('new-drag-pairs-list');
        
        if (newDragPairs.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">點擊「➕ 新增一組」開始設定</p>';
            return;
        }
        
        container.innerHTML = '';
        newDragPairs.forEach((pair, index) => {
            const pairDiv = document.createElement('div');
            pairDiv.className = 'grid grid-cols-12 gap-4 items-start p-4 bg-white rounded-lg border-2 border-gray-300 relative';
            pairDiv.innerHTML = `
                <div class="col-span-1 flex items-center justify-center">
                    <span class="text-2xl font-bold text-gray-400">${index + 1}</span>
                </div>
                <div class="col-span-5">
                    <label class="block text-sm font-bold text-amber-700 mb-2">
                        <span class="bg-amber-500 text-white px-2 py-1 rounded text-xs mr-1">左側</span>
                        程式片段（可拖拉）
                    </label>
                    <textarea data-pair-index="${index}" 
                              data-field="left"
                              class="input-style w-full h-20 font-mono text-sm drag-pair-input resize-y" 
                              placeholder="輸入程式碼片段，如：p = 2"></textarea>
                </div>
                <div class="col-span-5">
                    <label class="block text-sm font-bold text-blue-700 mb-2">
                        <span class="bg-blue-500 text-white px-2 py-1 rounded text-xs mr-1">右側</span>
                        槽位內容（留空或預設程式碼）
                    </label>
                    <textarea data-pair-index="${index}" 
                              data-field="right"
                              class="input-style w-full h-20 font-mono text-sm drag-pair-input resize-y" 
                              placeholder="留空表示拖放區，或輸入預設程式碼，如：if is_prime == True:"></textarea>
                </div>
                <div class="col-span-1 flex flex-col gap-2">
                    <button type="button" 
                            onclick="removeNewDragPair(${index})" 
                            class="bg-red-500 hover:bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold shadow-md"
                            title="刪除">
                        ✕
                    </button>
                    ${index > 0 ? `
                    <button type="button" 
                            onclick="moveNewDragPair(${index}, 'up')" 
                            class="bg-blue-500 hover:bg-blue-600 text-white rounded w-8 h-8 flex items-center justify-center font-bold shadow-md"
                            title="上移">
                        ↑
                    </button>
                    ` : ''}
                    ${index < newDragPairs.length - 1 ? `
                    <button type="button" 
                            onclick="moveNewDragPair(${index}, 'down')" 
                            class="bg-blue-500 hover:bg-blue-600 text-white rounded w-8 h-8 flex items-center justify-center font-bold shadow-md"
                            title="下移">
                        ↓
                    </button>
                    ` : ''}
                </div>
            `;
            container.appendChild(pairDiv);
        });
        
        // 設定輸入框的值
        newDragPairs.forEach((pair, index) => {
            const leftInput = container.querySelector(`textarea[data-pair-index="${index}"][data-field="left"]`);
            const rightInput = container.querySelector(`textarea[data-pair-index="${index}"][data-field="right"]`);
            if (leftInput) leftInput.value = pair.left;
            if (rightInput) rightInput.value = pair.right;
        });
        
        // 綁定輸入事件
        container.querySelectorAll('.drag-pair-input').forEach(input => {
            input.addEventListener('input', function() {
                const index = parseInt(this.dataset.pairIndex);
                const field = this.dataset.field;
                newDragPairs[index][field] = this.value;
            });
        });
    }

    // 刪除配對
    function removeNewDragPair(index) {
        newDragPairs.splice(index, 1);
        renderNewDragPairs();
    }

    // 移動配對順序
    function moveNewDragPair(index, direction) {
        if (direction === 'up' && index > 0) {
            [newDragPairs[index], newDragPairs[index - 1]] = [newDragPairs[index - 1], newDragPairs[index]];
        } else if (direction === 'down' && index < newDragPairs.length - 1) {
            [newDragPairs[index], newDragPairs[index + 1]] = [newDragPairs[index + 1], newDragPairs[index]];
        }
        renderNewDragPairs();
    }

    // === 編輯表單的拖拉方塊編輯器功能 ===
    
    // 新增一組配對（編輯表單）
    document.getElementById('edit-add-drag-row').addEventListener('click', function() {
        editDragPairs.push({ left: '', right: '' });
        renderEditDragPairs();
    });

    // 渲染配對列表（編輯表單）
    function renderEditDragPairs() {
        const container = document.getElementById('edit-drag-pairs-list');
        
        if (editDragPairs.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">點擊「➕ 新增一組」開始設定</p>';
            return;
        }
        
        container.innerHTML = '';
        editDragPairs.forEach((pair, index) => {
            const pairDiv = document.createElement('div');
            pairDiv.className = 'grid grid-cols-12 gap-4 items-start p-4 bg-white rounded-lg border-2 border-gray-300 relative';
            pairDiv.innerHTML = `
                <div class="col-span-1 flex items-center justify-center">
                    <span class="text-2xl font-bold text-gray-400">${index + 1}</span>
                </div>
                <div class="col-span-5">
                    <label class="block text-sm font-bold text-amber-700 mb-2">
                        <span class="bg-amber-500 text-white px-2 py-1 rounded text-xs mr-1">左側</span>
                        程式片段（可拖拉）
                    </label>
                    <textarea data-pair-index="${index}" 
                              data-field="left"
                              class="input-style w-full h-20 font-mono text-sm edit-drag-pair-input resize-y" 
                              placeholder="輸入程式碼片段，如：p = 2"></textarea>
                </div>
                <div class="col-span-5">
                    <label class="block text-sm font-bold text-blue-700 mb-2">
                        <span class="bg-blue-500 text-white px-2 py-1 rounded text-xs mr-1">右側</span>
                        槽位內容（留空或預設程式碼）
                    </label>
                    <textarea data-pair-index="${index}" 
                              data-field="right"
                              class="input-style w-full h-20 font-mono text-sm edit-drag-pair-input resize-y" 
                              placeholder="留空表示拖放區，或輸入預設程式碼，如：if is_prime == True:"></textarea>
                </div>
                <div class="col-span-1 flex flex-col gap-2">
                    <button type="button" 
                            onclick="removeEditDragPair(${index})" 
                            class="bg-red-500 hover:bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold shadow-md"
                            title="刪除">
                        ✕
                    </button>
                    ${index > 0 ? `
                    <button type="button" 
                            onclick="moveEditDragPair(${index}, 'up')" 
                            class="bg-blue-500 hover:bg-blue-600 text-white rounded w-8 h-8 flex items-center justify-center font-bold shadow-md"
                            title="上移">
                        ↑
                    </button>
                    ` : ''}
                    ${index < editDragPairs.length - 1 ? `
                    <button type="button" 
                            onclick="moveEditDragPair(${index}, 'down')" 
                            class="bg-blue-500 hover:bg-blue-600 text-white rounded w-8 h-8 flex items-center justify-center font-bold shadow-md"
                            title="下移">
                        ↓
                    </button>
                    ` : ''}
                </div>
            `;
            container.appendChild(pairDiv);
        });
        
        // 設定輸入框的值
        editDragPairs.forEach((pair, index) => {
            const leftInput = container.querySelector(`textarea[data-pair-index="${index}"][data-field="left"]`);
            const rightInput = container.querySelector(`textarea[data-pair-index="${index}"][data-field="right"]`);
            if (leftInput) leftInput.value = pair.left;
            if (rightInput) rightInput.value = pair.right;
        });
        
        // 綁定輸入事件
        container.querySelectorAll('.edit-drag-pair-input').forEach(input => {
            input.addEventListener('input', function() {
                const index = parseInt(this.dataset.pairIndex);
                const field = this.dataset.field;
                editDragPairs[index][field] = this.value;
            });
        });
    }

    // 刪除配對（編輯表單）
    function removeEditDragPair(index) {
        editDragPairs.splice(index, 1);
        renderEditDragPairs();
    }

    // 移動配對順序（編輯表單）
    function moveEditDragPair(index, direction) {
        if (direction === 'up' && index > 0) {
            [editDragPairs[index], editDragPairs[index - 1]] = [editDragPairs[index - 1], editDragPairs[index]];
        } else if (direction === 'down' && index < editDragPairs.length - 1) {
            [editDragPairs[index], editDragPairs[index + 1]] = [editDragPairs[index + 1], editDragPairs[index]];
        }
        renderEditDragPairs();
    }

    // 編輯表單的拖拉方塊編輯器狀態
    let editDragPairs = []; // 格式：[{left: '', right: ''}, ...]

    // 更新題型格式提示（編輯表單）
    document.getElementById('edit-type').addEventListener('change', function() {
        const selectedType = this.value;
        const standardFields = document.getElementById('edit-standard-fields');
        const dragBlockEditor = document.getElementById('edit-drag-block-editor');
        const optionsField = document.getElementById('edit-options');
        const formatHint = document.getElementById('edit-format-hint');
        const answerHelp = document.getElementById('edit-answer-help');
        const answerField = document.getElementById('edit-answer');
        
        // 切換顯示模式
        if (selectedType === '拖拉方塊') {
            // 完全隱藏標準欄位（選項和答案）
            standardFields.classList.add('hidden');
            dragBlockEditor.classList.remove('hidden');
            // 移除標準欄位的 required 屬性
            optionsField.removeAttribute('required');
            answerField.removeAttribute('required');
            
            // 如果有現有數據，解析並顯示
            if (optionsField.value && optionsField.value.trim()) {
                editDragPairs = optionsField.value.split('\n').filter(line => line.trim());
                renderEditCodeBlocks();
            }
        } else {
            // 顯示標準欄位，隱藏拖拉方塊編輯器
            standardFields.classList.remove('hidden');
            dragBlockEditor.classList.add('hidden');
            // 恢復 required 屬性
            optionsField.setAttribute('required', 'required');
            answerField.setAttribute('required', 'required');
            answerField.removeAttribute('readonly');
        }
        
        if (selectedType && questionTypeFormats[selectedType]) {
            const format = questionTypeFormats[selectedType];
            optionsField.placeholder = format.optionsPlaceholder;
            formatHint.textContent = format.optionsHint;
            answerHelp.textContent = format.answerHint;
            
            // 只有連連看自動填入 auto
            if (selectedType === '連連看') {
                if (!answerField.value || answerField.value === '') {
                    answerField.value = 'auto';
                }
            } else {
                // 其他題型（包括拖拉方塊）如果是 auto 就清空，讓管理者填寫
                if (answerField.value === 'auto' && selectedType !== '連連看') {
                    answerField.value = '';
                }
            }
        } else {
            optionsField.placeholder = '請先選擇題型';
            formatHint.textContent = '請先選擇題型';
            answerHelp.textContent = '';
        }
    });

    // ========== 新功能：手動新增按鈕 ==========
    const addModal = document.getElementById('add-question-modal');
    const addForm = document.getElementById('add-question-form');
    
    document.getElementById('manual-add-button').addEventListener('click', function() {
        // 重置拖拉方塊編輯器
        newDragPairs = [];
        renderNewDragPairs();
        
        addModal.classList.remove('hidden');
        addModal.classList.add('flex');
        lucide.createIcons();
    });
    
    document.getElementById('cancel-add-button').addEventListener('click', function() {
        addModal.classList.add('hidden');
        addModal.classList.remove('flex');
        addForm.reset();
        // 清空拖拉方塊編輯器
        newDragPairs = [];
        renderNewDragPairs();
    });
    
    addForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const questionType = document.getElementById('new-type').value;
        let options, answer;
        
        // 如果是拖拉方塊，從編輯器獲取數據
        if (questionType === '拖拉方塊') {
            if (newDragPairs.length === 0) {
                showMessage('❌ 請至少新增一組配對');
                return;
            }
            
            // 檢查左側是否都有填寫
            const hasEmptyLeft = newDragPairs.some(pair => !pair.left.trim());
            if (hasEmptyLeft) {
                showMessage('❌ 左側程式片段不能為空');
                return;
            }
            
            // 格式：左側|右側\n左側|右側（右側可以為空）
            options = newDragPairs.map(pair => `${pair.left.trim()}|${pair.right.trim()}`).join('\n');
            // 從拖拉方塊專用答案欄位獲取答案
            answer = document.getElementById('new-drag-answer').value;
        } else {
            options = document.getElementById('new-options').value;
            answer = document.getElementById('new-answer').value;
        }
        
        const newQuestion = {
            course: document.getElementById('new-course').value,
            chapter: document.getElementById('new-chapter').value,
            knowledge: document.getElementById('new-knowledge').value,
            type: questionType,
            content: document.getElementById('new-content').value,
            options: options,
            answer: answer
        };
        
        try {
            const response = await fetch(`${API_BASE_URL}/questions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newQuestion)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showMessage('✅ 考題新增成功！');
                addModal.classList.add('hidden');
                addModal.classList.remove('flex');
                addForm.reset();
                // 清空拖拉方塊編輯器
                newDragPairs = [];
                renderNewDragPairs();
                fetchQuestions(); // 重新載入資料
            } else {
                showMessage('❌ 新增失敗：' + result.message);
            }
        } catch (error) {
            showMessage('❌ 新增失敗：' + error.message);
        }
    });

    // ========== 新功能：Excel 匯入 ==========
    const importModal = document.getElementById('import-modal');
    const fileInput = document.getElementById('excel-file-input');
    const fileName = document.getElementById('file-name');
    const confirmImportBtn = document.getElementById('confirm-import-button');
    let selectedFile = null;
    
    document.getElementById('import-button').addEventListener('click', function() {
        importModal.classList.remove('hidden');
        importModal.classList.add('flex');
        lucide.createIcons();
    });
    
    document.getElementById('cancel-import-button').addEventListener('click', function() {
        importModal.classList.add('hidden');
        importModal.classList.remove('flex');
        fileInput.value = '';
        fileName.textContent = '';
        selectedFile = null;
        confirmImportBtn.disabled = true;
    });
    
    fileInput.addEventListener('change', function(e) {
        selectedFile = e.target.files[0];
        if (selectedFile) {
            fileName.textContent = `已選擇：${selectedFile.name}`;
            confirmImportBtn.disabled = false;
        }
    });
    
    confirmImportBtn.addEventListener('click', async function() {
        if (!selectedFile) {
            showMessage('請先選擇檔案');
            return;
        }
        
        try {
            // 讀取 Excel 檔案
            const data = await selectedFile.arrayBuffer();
            const workbook = XLSX.read(data);
            
            // 讀取第一個工作表
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            
            // 轉換為 JSON（第一行為標題）
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            if (jsonData.length === 0) {
                showMessage('❌ Excel 檔案沒有資料');
                return;
            }
            
            // 轉換為後端期望的格式
            const questions = jsonData.map(row => {
                const questionData = {
                    course: row['課別'] || row['课别'] || '',
                    chapter: row['章節'] || row['章节'] || '',
                    knowledge: row['知識點'] || row['知识点'] || '',
                    type: row['題型'] || row['题型'] || '',
                    content: row['題目內容'] || row['题目内容'] || '',
                    options: row['選項'] || row['选项'] || '',
                    answer: row['答案'] || ''
                };
                
                // 處理拖拉方塊的選項格式（如果使用分號分隔）
                if (questionData.type === '拖拉方塊' && questionData.options) {
                    // 確保格式正確
                    if (!questionData.options.includes('\n') && questionData.options.includes(';')) {
                        // 分號分隔格式，保持原樣（後端會處理）
                    }
                }
                
                return questionData;
            });
            
            console.log('📤 準備匯入的資料:', questions);
            
            // 發送到後端
            const response = await fetch(`${API_BASE_URL}/questions/import`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ questions })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showMessage(`✅ 成功匯入 ${result.imported || 0} 筆考題！${result.failed > 0 ? `失敗 ${result.failed} 筆` : ''}`);
                importModal.classList.add('hidden');
                importModal.classList.remove('flex');
                fileInput.value = '';
                fileName.textContent = '';
                selectedFile = null;
                confirmImportBtn.disabled = true;
                fetchQuestions(); // 重新載入資料
            } else {
                showMessage('❌ 匯入失敗：' + result.message);
            }
        } catch (error) {
            console.error('匯入錯誤:', error);
            showMessage('❌ 匯入失敗：' + error.message);
        }
    });

    // ========== 考題分派功能 ==========
    let allQuestions = []; // 儲存所有考題
    let allModes = []; // 儲存所有模式

    // 載入考題分派所需資料
    async function loadAssignmentData() {
        try {
            // 同時載入考題和模式
            const [questionsRes, modesRes] = await Promise.all([
                fetch(`${API_BASE_URL}/questions`),
                fetch(`${API_BASE_URL}/modes`)
            ]);
            
            const questionsData = await questionsRes.json();
            const modesData = await modesRes.json();
            
            if (questionsData.success) {
                allQuestions = questionsData.data;
                populateAssignmentCourses();
            }
            
            if (modesData.success) {
                allModes = modesData.data;
                populateAssignmentModes();
            }
            
            console.log('✅ 考題分派資料載入完成');
        } catch (error) {
            console.warn('⚠️ 無法載入考題分派資料:', error.message);
        }
    }

    // 填充課程下拉選單
    function populateAssignmentCourses() {
        const courseSelect = document.getElementById('assign-course-select');
        const courses = [...new Set(allQuestions.map(q => q.course))].filter(Boolean);
        
        courseSelect.innerHTML = '<option value="">請選擇課程</option>';
        courses.forEach(course => {
            const option = document.createElement('option');
            option.value = course;
            option.textContent = course;
            courseSelect.appendChild(option);
        });
    }

    // 填充模式下拉選單
    function populateAssignmentModes() {
        const modeSelect = document.getElementById('assign-mode-select');
        
        modeSelect.innerHTML = '<option value="">請選擇模式</option>';
        allModes.forEach(mode => {
            const option = document.createElement('option');
            option.value = mode.name;
            option.textContent = mode.name;
            modeSelect.appendChild(option);
        });
    }

    // 確定/預覽按鈕事件
    document.getElementById('confirm-assignment-button').addEventListener('click', function() {
        const selectedCourse = document.getElementById('assign-course-select').value;
        const selectedMode = document.getElementById('assign-mode-select').value;
        
        if (!selectedCourse) {
            showMessage('⚠️ 請選擇課程');
            return;
        }
        
        if (!selectedMode) {
            showMessage('⚠️ 請選擇考題模式');
            return;
        }
        
        // 篩選符合條件的考題
        const filteredQuestions = allQuestions.filter(q => 
            q.course === selectedCourse && q.type === selectedMode
        );
        
        if (filteredQuestions.length === 0) {
            showMessage(`❌ 沒有找到符合「${selectedCourse} - ${selectedMode}」的考題`);
            return;
        }
        
        // 顯示考題預覽
        displayAssignmentPreview(selectedCourse, selectedMode, filteredQuestions);
    });

    // 顯示考題預覽
    function displayAssignmentPreview(course, mode, questions) {
        const placeholder = document.getElementById('assignment-placeholder');
        const preview = document.getElementById('assignment-preview');
        const questionsList = document.getElementById('assignment-questions-list');
        
        // 隱藏提示,顯示預覽
        placeholder.classList.add('hidden');
        preview.classList.remove('hidden');
        
        // 更新預覽資訊
        document.getElementById('preview-course').textContent = course;
        document.getElementById('preview-mode').textContent = mode;
        document.getElementById('preview-count').textContent = questions.length;
        
        // 渲染考題列表
        questionsList.innerHTML = '';
        questions.forEach((q, index) => {
            const questionCard = document.createElement('div');
            questionCard.className = 'bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500 hover:shadow-lg transition';
            
            questionCard.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center mb-3">
                            <span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold mr-3">第 ${index + 1} 題</span>
                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">${q.type}</span>
                            ${q.chapter ? `<span class="ml-2 text-gray-500 text-sm">${q.chapter}</span>` : ''}
                            ${q.knowledge ? `<span class="ml-2 text-gray-500 text-sm">・${q.knowledge}</span>` : ''}
                        </div>
                        <div class="text-gray-800 font-medium mb-3 text-lg">${q.content || '題目內容'}</div>
                        ${q.options ? `
                            <div class="bg-gray-50 p-4 rounded-lg mb-3">
                                <div class="text-sm text-gray-600 mb-2 font-semibold">選項：</div>
                                <div class="text-gray-700">${formatOptions(q.options, q.type)}</div>
                            </div>
                        ` : ''}
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center">
                                <span class="text-gray-500 mr-2">正確答案：</span>
                                <span class="bg-green-100 text-green-800 px-3 py-1 rounded font-semibold">${q.answer || '未設定'}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="copyQuestionLink('${q._id}', '${q.type}')" 
                                   class="inline-flex items-center px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-semibold shadow-md text-sm">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                    複製連結
                                </button>
                                <a href="${window.location.pathname.includes('/studenttest/') ? '/studenttest/' : ''}${q.type === '拖拉方塊' ? 'code-drag-game.html' : 'exam-player.html'}?id=${q._id}" target="_blank" rel="noopener noreferrer"
                                   class="inline-flex items-center px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition font-semibold shadow-md">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    開始答題
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            questionsList.appendChild(questionCard);
        });
        
        // 重新初始化圖示
        lucide.createIcons();
    }

    // 格式化選項顯示
    function formatOptions(options, questionType) {
        if (!options) return '';
        
        // 如果是字串
        if (typeof options === 'string') {
            // 連連看格式: 使用 | 分隔的配對
            if (questionType === '連連看' && options.includes('|')) {
                const pairs = options.split('\n').filter(line => line.trim());
                return `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-purple-50 p-3 rounded">
                            <div class="text-xs font-semibold text-purple-600 mb-2">左側項目</div>
                            ${pairs.map(pair => {
                                const [left] = pair.split('|');
                                return `<div class="bg-white px-3 py-2 rounded mb-2 border border-purple-200">${left.trim()}</div>`;
                            }).join('')}
                        </div>
                        <div class="bg-blue-50 p-3 rounded">
                            <div class="text-xs font-semibold text-blue-600 mb-2">右側項目</div>
                            ${pairs.map(pair => {
                                const parts = pair.split('|');
                                const right = parts[1] || '';
                                return `<div class="bg-white px-3 py-2 rounded mb-2 border border-blue-200">${right.trim()}</div>`;
                            }).join('')}
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500 italic">
                        💡 學生需要將左側項目連接到對應的右側項目
                    </div>
                `;
            }
            
            // 拖拉方塊格式: 左側|右側 - 雙欄布局模擬學生答題畫面
            if (questionType === '拖拉方塊') {
                const items = options.split('\n').filter(line => line.trim());
                const leftItems = items.map((item, index) => {
                    const [left] = item.split('|').map(s => s.trim());
                    return { index, text: left };
                });
                const rightItems = items.map((item, index) => {
                    const parts = item.split('|');
                    const right = parts[1] ? parts[1].trim() : '';
                    return { index, text: right };
                });
                
                return `
                    <div class="bg-amber-50 p-4 rounded-lg border-2 border-amber-200">
                        <div class="text-xs font-semibold text-amber-700 mb-3 flex items-center">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                            </svg>
                            拖曳配對組合
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <!-- 左側：可選程式碼片段 -->
                            <div>
                                <div class="text-xs font-semibold text-amber-800 mb-3 bg-amber-100 px-3 py-2 rounded-lg">可選程式碼片段</div>
                                <div class="space-y-2">
                                    ${leftItems.map(item => `
                                        <div class="bg-sky-50 px-4 py-3 rounded-lg border-2 border-sky-300 shadow-sm font-mono text-sm">
                                            ${item.text || '(空白)'}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- 右側：回答區（拖曳目標） -->
                            <div>
                                <div class="text-xs font-semibold text-amber-800 mb-3 bg-amber-100 px-3 py-2 rounded-lg">回答區</div>
                                <div class="space-y-2">
                                    ${rightItems.map((item, index) => `
                                        <div class="min-h-[3rem] border-2 border-dashed border-gray-400 bg-gray-50 rounded-lg p-3 flex items-center">
                                            ${item.text ? `
                                                <div class="bg-white border border-gray-300 px-3 py-2 rounded font-mono text-sm flex-grow">
                                                    ${item.text}
                                                </div>
                                            ` : `
                                                <span class="text-gray-400 text-sm italic">${index + 1}. (拖曳目標)</span>
                                            `}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500 italic flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        學生需將左側程式片段拖曳到對應的右側目標位置
                    </div>
                `;
            }
            
            // 一般選項格式(用換行分隔)
            if (options.includes('\n')) {
                return options.split('\n').filter(line => line.trim()).map(opt => 
                    `<div class="mb-1 pl-3 border-l-2 border-gray-300">${opt.trim()}</div>`
                ).join('');
            }
            
            // 逗號分隔格式(舊格式相容)
            if (options.includes(',')) {
                return options.split(',').map(opt => 
                    `<div class="mb-1 pl-3 border-l-2 border-gray-300">${opt.trim()}</div>`
                ).join('');
            }
            
            return options;
        }
        
        // 如果是物件或陣列
        return JSON.stringify(options);
    }

    // 複製題目連結到剪貼簿
    function copyQuestionLink(questionId, questionType) {
        const basePath = window.location.pathname.includes('/studenttest/') ? '/studenttest/' : '/';
        const page = questionType === '拖拉方塊' ? 'code-drag-game.html' : 'exam-player.html';
        const link = `${window.location.origin}${basePath}${page}?id=${questionId}`;
        
        // 使用現代剪貼簿 API
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(link).then(() => {
                showMessage('✅ 連結已複製到剪貼簿！可以分享給學生了', 'success');
            }).catch(() => {
                fallbackCopyTextToClipboard(link);
            });
        } else {
            fallbackCopyTextToClipboard(link);
        }
    }

    // 備用複製方法（支援舊版瀏覽器）
    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            showMessage('✅ 連結已複製到剪貼簿！可以分享給學生了', 'success');
        } catch (err) {
            showMessage('❌ 複製失敗，請手動複製連結', 'error');
            console.error('複製失敗:', err);
        }
        
        document.body.removeChild(textArea);
    }

    // ========== 模式管理功能 ==========
    
    let modeCounter = 6; // 已有 6 個預設模式
    
    // 創建新的模式區塊
    function createModeBlock(index, name = '', code = '') {
        const modeBlock = document.createElement('div');
        modeBlock.className = 'mode-block grid grid-cols-1 lg:grid-cols-2 gap-8 items-start p-4 border border-gray-200 rounded-xl bg-gray-50 relative';
        modeBlock.dataset.modeIndex = index;
        
        modeBlock.innerHTML = `
            <div class="flex items-start space-x-4">
                <div class="flex flex-col items-center w-8">
                    <span class="text-2xl font-mono text-gray-500">${index}.</span>
                    <input type="checkbox" class="mode-checkbox mt-2 w-5 h-5 cursor-pointer" data-mode-index="${index}">
                </div>
                <div class="flex-grow">
                    <label class="text-sm font-medium text-gray-600 mb-2 block">HTML/JS/CSS code(VUE)</label>
                    <textarea id="mode-code-${index}" class="input-style w-full h-40 focus:outline-none focus:ring-2 focus:ring-orange-500 p-3 text-sm font-mono resize-none" placeholder="在此輸入 VUE 單檔案組件代碼...">${code}</textarea>
                </div>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-600 mb-2 block">對應模式名稱</label>
                <input id="mode-name-${index}" type="text" value="${name}" class="input-style w-full text-lg font-bold text-center py-4 bg-yellow-200 border-yellow-500 text-gray-800 focus:outline-none focus:ring-2 focus:ring-orange-500" placeholder="請輸入模式名稱">
            </div>
        `;
        
        return modeBlock;
    }
    
    // 全選按鈕事件
    document.getElementById('select-all-modes-button').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.mode-checkbox');
        checkboxes.forEach(cb => cb.checked = true);
        showMessage(`✅ 已全選 ${checkboxes.length} 個模式`, 'success');
    });
    
    // 取消全選按鈕事件
    document.getElementById('deselect-all-modes-button').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.mode-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
        showMessage('✅ 已取消全選', 'success');
    });
    
    // 批次刪除按鈕事件
    document.getElementById('delete-selected-modes-button').addEventListener('click', function() {
        const selectedCheckboxes = document.querySelectorAll('.mode-checkbox:checked');
        
        if (selectedCheckboxes.length === 0) {
            showMessage('⚠️ 請先選擇要刪除的模式', 'warning');
            return;
        }
        
        if (!confirm(`確定要刪除 ${selectedCheckboxes.length} 個已選模式嗎？`)) {
            return;
        }
        
        selectedCheckboxes.forEach(checkbox => {
            const modeIndex = checkbox.dataset.modeIndex;
            const block = document.querySelector(`.mode-block[data-mode-index="${modeIndex}"]`);
            if (block) {
                block.remove();
            }
        });
        
        // 重新編號
        renumberModeBlocks();
        
        showMessage(`✅ 已刪除 ${selectedCheckboxes.length} 個模式`, 'success');
    });
    
    // 新增模式按鈕事件
    document.getElementById('add-mode-button').addEventListener('click', function() {
        modeCounter++;
        const container = document.getElementById('modes-container');
        const newBlock = createModeBlock(modeCounter);
        
        // 取得操作按鈕區元素（按鈕區永遠在最後）
        const buttonArea = container.querySelector('.mt-8.space-y-4');
        
        // 按照編號順序插入到正確位置（但要在按鈕區之前）
        const allBlocks = container.querySelectorAll('.mode-block');
        let inserted = false;
        
        allBlocks.forEach(block => {
            const blockIndex = parseInt(block.dataset.modeIndex);
            if (!inserted && blockIndex > modeCounter) {
                container.insertBefore(newBlock, block);
                inserted = true;
            }
        });
        
        // 如果沒有插入（新區塊編號最大），則插入到按鈕區之前
        if (!inserted) {
            container.insertBefore(newBlock, buttonArea);
        }
        
        // 重新初始化圖示
        lucide.createIcons();
        
        showMessage(`✅ 已新增第 ${modeCounter} 個模式區塊`, 'success');
    });
    
    // 刪除模式區塊
    window.removeModeBlock = function(index) {
        const block = document.querySelector(`.mode-block[data-mode-index="${index}"]`);
        if (block) {
            block.remove();
            showMessage(`✅ 已刪除模式區塊`, 'success');
            // 重新編號
            renumberModeBlocks();
        }
    };
    
    // 重新編號模式區塊
    function renumberModeBlocks() {
        const blocks = document.querySelectorAll('.mode-block');
        blocks.forEach((block, index) => {
            const newIndex = index + 1;
            const oldIndex = block.dataset.modeIndex;
            
            block.dataset.modeIndex = newIndex;
            
            // 更新編號顯示
            const numberSpan = block.querySelector('span.text-2xl');
            if (numberSpan) numberSpan.textContent = `${newIndex}.`;
            
            // 更新 checkbox
            const checkbox = block.querySelector('.mode-checkbox');
            if (checkbox) {
                checkbox.dataset.modeIndex = newIndex;
                checkbox.checked = false; // 重置選中狀態
            }
            
            // 更新 ID
            const codeTextarea = block.querySelector(`#mode-code-${oldIndex}`);
            const nameInput = block.querySelector(`#mode-name-${oldIndex}`);
            
            if (codeTextarea) codeTextarea.id = `mode-code-${newIndex}`;
            if (nameInput) nameInput.id = `mode-name-${newIndex}`;
        });
        
        modeCounter = blocks.length;
    }
    
    // 載入已儲存的模式資料
    async function loadModes() {
        try {
            const response = await fetch(`${API_BASE_URL}/modes`);
            const result = await response.json();
            
            const container = document.getElementById('modes-container');
            
            if (result.success && result.data.length > 0) {
                // 先移除所有超過資料庫模式數量的區塊
                const allBlocks = document.querySelectorAll('.mode-block');
                allBlocks.forEach((block, index) => {
                    if (index >= result.data.length) {
                        block.remove();
                    }
                });
                
                // 填充或創建資料庫中的模式
                result.data.forEach((mode, index) => {
                    const modeNum = index + 1;
                    let existingBlock = document.querySelector(`.mode-block[data-mode-index="${modeNum}"]`);
                    
                    if (existingBlock) {
                        // 更新現有區塊
                        const nameInput = existingBlock.querySelector(`#mode-name-${modeNum}`);
                        const codeInput = existingBlock.querySelector(`#mode-code-${modeNum}`);
                        
                        if (nameInput) nameInput.value = mode.name || '';
                        if (codeInput) codeInput.value = mode.code || '';
                    } else {
                        // 創建新區塊
                        const newBlock = createModeBlock(modeNum, mode.name || '', mode.code || '');
                        container.appendChild(newBlock);
                    }
                });
                
                // 更新計數器
                modeCounter = result.data.length;
                
                // 重新編號確保一致性
                renumberModeBlocks();
                
                // 重新初始化圖示
                lucide.createIcons();
                
                console.log(`✅ 已載入 ${result.data.length} 個模式資料`);
            } else {
                // 沒有資料，移除所有超過前 0 個的區塊（保留預設的 6 個但清空）
                const allBlocks = document.querySelectorAll('.mode-block');
                allBlocks.forEach((block, index) => {
                    if (index < 6) {
                        // 保留前 6 個預設區塊，但清空內容
                        const modeNum = index + 1;
                        const nameInput = block.querySelector(`#mode-name-${modeNum}`);
                        const codeInput = block.querySelector(`#mode-code-${modeNum}`);
                        if (nameInput) nameInput.value = '';
                        if (codeInput) codeInput.value = '';
                    } else {
                        // 移除第 7 個以後的區塊
                        block.remove();
                    }
                });
                modeCounter = 6;
                console.log('⚠️ 資料庫中沒有模式資料，已清空所有區塊');
            }
            
            // 載入完成後顯示容器（避免閃現）
            container.classList.remove('opacity-0');
            container.classList.add('opacity-100');
        } catch (error) {
            console.warn('⚠️ 無法載入模式資料:', error.message);
            // 即使出錯也要顯示容器
            const container = document.getElementById('modes-container');
            if (container) {
                container.classList.remove('opacity-0');
                container.classList.add('opacity-100');
            }
        }
    }

    // 儲存模式按鈕事件
    document.getElementById('save-modes-button').addEventListener('click', async function() {
        const modes = [];
        
        // 收集所有模式資料（動態數量）
        const modeBlocks = document.querySelectorAll('.mode-block');
        modeBlocks.forEach((block, index) => {
            const modeNum = index + 1;
            const nameInput = block.querySelector(`#mode-name-${modeNum}`);
            const codeInput = block.querySelector(`#mode-code-${modeNum}`);
            
            if (nameInput) {
                const name = nameInput.value.trim();
                const code = codeInput ? codeInput.value.trim() : '';
                
                if (name) {
                    modes.push({
                        name: name,
                        code: code || '',
                        description: `${name}模式`,
                        order: modeNum
                    });
                }
            }
        });
        
        try {
            // 先刪除所有現有模式（確保刪除完成）
            console.log('🗑️ 正在刪除所有現有模式...');
            const deleteResponse = await fetch(`${API_BASE_URL}/modes`, {
                method: 'DELETE'
            });
            
            if (!deleteResponse.ok) {
                throw new Error(`刪除失敗: HTTP ${deleteResponse.status}`);
            }
            
            const deleteResult = await deleteResponse.json();
            console.log('✅ 刪除完成:', deleteResult);
            
            // 如果沒有要儲存的模式，直接完成
            if (modes.length === 0) {
                showMessage('✅ 已清空所有模式');
                loadAssignmentData();
                return;
            }
            
            // 批次新增模式
            console.log(`📝 正在新增 ${modes.length} 個模式...`);
            const savePromises = modes.map(mode => 
                fetch(`${API_BASE_URL}/modes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mode)
                })
            );
            
            const responses = await Promise.all(savePromises);
            const results = await Promise.all(responses.map(r => r.json()));
            
            const successCount = results.filter(r => r.success).length;
            
            if (successCount > 0) {
                showMessage(`✅ 成功儲存 ${successCount} 個模式！`);
                console.log('✅ 儲存完成');
                // 重新載入考題分派的模式選單
                loadAssignmentData();
            } else {
                showMessage('❌ 儲存失敗，請稍後再試');
            }
        } catch (error) {
            showMessage('❌ 儲存失敗：' + error.message);
            console.error('儲存模式錯誤:', error);
        }
    });

    // ===== 答題記錄相關函數 =====
    let allRecords = [];
    let filteredRecords = [];

    // 載入答題記錄
    async function loadRecords() {
        try {
            const response = await fetch(`${API_BASE_URL}/records`);
            const result = await response.json();
            
            if (result.success) {
                allRecords = result.data;
                filteredRecords = [...allRecords];
                
                // 更新統計摘要
                updateStatsSummary();
                
                // 更新篩選器選項
                populateFilters();
                
                // 顯示記錄表格
                displayRecords(filteredRecords);
            } else {
                showNoRecords();
            }
        } catch (error) {
            console.error('載入記錄失敗:', error);
            showNoRecords('載入記錄時發生錯誤');
        }
    }

    // 更新統計摘要
    function updateStatsSummary() {
        const totalAttempts = allRecords.length;
        const correctAttempts = allRecords.filter(r => r.isCorrect).length;
        const correctRate = totalAttempts > 0 ? ((correctAttempts / totalAttempts) * 100).toFixed(1) : 0;
        const avgTime = totalAttempts > 0 ? Math.round(allRecords.reduce((sum, r) => sum + (r.timeSpent || 0), 0) / totalAttempts) : 0;

        document.getElementById('total-attempts').textContent = totalAttempts;
        document.getElementById('correct-attempts').textContent = correctAttempts;
        document.getElementById('overall-rate').textContent = correctRate + '%';
        document.getElementById('avg-time').textContent = avgTime + '秒';
    }

    // 填充篩選器選項
    function populateFilters() {
        // 題型篩選
        const types = [...new Set(allRecords.map(r => r.questionType).filter(Boolean))];
        const typeSelect = document.getElementById('filter-type');
        typeSelect.innerHTML = '<option value="">全部題型</option>';
        types.forEach(type => {
            typeSelect.innerHTML += `<option value="${type}">${type}</option>`;
        });

        // 課程篩選
        const courses = [...new Set(allRecords.map(r => r.courseName).filter(Boolean))];
        const courseSelect = document.getElementById('filter-course');
        courseSelect.innerHTML = '<option value="">全部課程</option>';
        courses.forEach(course => {
            courseSelect.innerHTML += `<option value="${course}">${course}</option>`;
        });
    }

    // 篩選記錄
    function filterRecords() {
        const typeFilter = document.getElementById('filter-type').value;
        const resultFilter = document.getElementById('filter-result').value;
        const courseFilter = document.getElementById('filter-course').value;

        filteredRecords = allRecords.filter(record => {
            if (typeFilter && record.questionType !== typeFilter) return false;
            if (resultFilter === 'correct' && !record.isCorrect) return false;
            if (resultFilter === 'incorrect' && record.isCorrect) return false;
            if (courseFilter && record.courseName !== courseFilter) return false;
            return true;
        });

        displayRecords(filteredRecords);
    }

    // 顯示記錄表格
    function displayRecords(records) {
        const tbody = document.getElementById('records-table-body');
        
        if (records.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                        <p>目前沒有符合條件的記錄</p>
                    </td>
                </tr>
            `;
            lucide.createIcons();
            return;
        }

        tbody.innerHTML = records.map(record => {
            const date = new Date(record.answeredAt);
            const formattedDate = `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getDate().toString().padStart(2,'0')} ${date.getHours().toString().padStart(2,'0')}:${date.getMinutes().toString().padStart(2,'0')}`;
            const resultBadge = record.isCorrect 
                ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">✓ 答對</span>'
                : '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded-full">✗ 答錯</span>';
            
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formattedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.courseName || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.questionType || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded font-mono text-xs">${record.answer || '-'}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">
                        <span class="px-2 py-1 bg-gray-50 text-gray-700 rounded font-mono text-xs">${record.correctAnswer || '-'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${resultBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.timeSpent || 0} 秒</td>
                </tr>
            `;
        }).join('');
        
        lucide.createIcons();
    }

    // 顯示無記錄訊息
    function showNoRecords(message = '目前還沒有任何答題記錄') {
        const tbody = document.getElementById('records-table-body');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                    <p>${message}</p>
                </td>
            </tr>
        `;
        lucide.createIcons();
        
        // 清空統計
        document.getElementById('total-attempts').textContent = '0';
        document.getElementById('correct-attempts').textContent = '0';
        document.getElementById('overall-rate').textContent = '0%';
        document.getElementById('avg-time').textContent = '0秒';
    }

    // 重新整理記錄
    function refreshRecords() {
        loadRecords();
        showMessage('✓ 記錄已重新整理');
    }

    // Initial Tab Setup: Set '考題分派' as active on load and render questions for '考題管理'
    window.onload = function() {
        // Set '考題分派' as the initial active tab
        document.querySelector('.tab-button[data-tab="assignment"]').click();
        
        // 預先載入考題資料
        fetchQuestions();
        
        // 載入考題分派資料
        loadAssignmentData();
        
        // 載入模式管理資料
        loadModes();
        
        // 載入答題記錄
        loadRecords();
        
        // Initialize all icons
        lucide.createIcons();
    }
</script>

</body>
</html>